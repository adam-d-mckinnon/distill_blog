---
title: "Prediction Promotions"
description: |
  Building an XGBoost model in the Tidymodels ecosystem that predicts which employees should be promoted.
author:
  - name: Adam D McKinnon
    url: https://adam-d-mckinnon.com/
date: "`r Sys.Date()`"
categories:
  - Tidymodels
  - XGBoost
  - R
output: 
  distill::distill_article:
    df_print: paged
    code_folding: true
    self_contained: false
    date_prefix: true # adds date for sorting
    toc: true
    toc_depth: 3
    toc_float: true
    highlight: rstudio
    highlight_downlit: true
    draft: true


---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  comment = "##",
  out.width = "100%",
  out.height = "100%",
  dpi = 300,
  code_folding = TRUE,
  R.options = list(width = 70))

```



```{r header, echo=FALSE, code_folding = FALSE, fig.cap="Photo by [Possessed Photography](https://unsplash.com/@possessedphotography) on [Unsplash](https://unsplash.com/).", out.width = '100%'}
knitr::include_graphics("shorter_stairs.jpg")

```


# Libraries
```{r loading_libraries}

# data manipulation
library(readxl)
library(tidyverse)
library(janitor)

# modelling
library(tidymodels)

# Processing power
library(doParallel)
library(parallelly)


tidymodels_prefer()

```

# Data
```{r loading_data}

# Load Data ----
promotions_tbl <- readxl::read_excel(path = "promotion_prediction_files/2022_12_15_promotions.xlsx")


promotions_tbl <- promotions_tbl %>% 
    mutate(
        promoted  = forcats::as_factor(promoted) %>% forcats::fct_relevel("promoted", "not promoted")
    ) %>% 
    mutate_at(.vars = c("gender", "work_site", "management_level"), .funs = ~ forcats::as_factor(.))



```




## Spending the data wisely
```{r}

# Spending the dataset ----

set.seed(836)
promotion_split     <- initial_split(promotions_tbl, strata = promoted)
promotion_train_tbl <- training(promotion_split)
promotion_test_tbl  <- testing(promotion_split)


set.seed(234)
promotion_folds <- bootstraps(promotion_train_tbl, 
                              times = 25, # default
                              strata = promoted)

# promotion_folds



```




# Preprocessing the data
```{r data_preprocessing}

# Data Pre-processing ----
xgboost_recipe <- 
    recipe(formula = promoted ~ ., data = promotion_train_tbl) %>% 
    recipes::update_role(employee_id, new_role = "id") %>% 
    step_dummy(all_nominal_predictors(), one_hot = TRUE) %>% 
    step_zv(all_predictors()) 


```




# 
```{r model_spec}

# 3. Model Set-up ----
xgboost_spec <- 
    boost_tree(trees = 1000, 
               tree_depth = tune(), min_n = tune(), 
               loss_reduction = tune(), 
               sample_size = tune(), mtry = tune(),
               learn_rate = tune()) %>% 
    set_engine("xgboost") %>% 
    set_mode("classification")

xgboost_spec

```

```{r model_tuning_spec}

# 4. Model Grid ----
xgboost_grid <- grid_latin_hypercube(
    tree_depth(),
    min_n(),
    loss_reduction(),
    sample_size = sample_prop(),
    finalize(mtry(), promotion_train_tbl),
    learn_rate(),
    size = 50
)

xgboost_grid

```


# Workflow

```{r workflow_setup}


# Workflow ----
xgboost_workflow <- 
    workflow() %>% 
    add_recipe(xgboost_recipe) %>% 
    add_model(xgboost_spec) 

xgboost_workflow


# define the metrics of interest
promotion_metrics <- metric_set(mn_log_loss, roc_auc, accuracy, sensitivity, specificity)

```

# Tuning the Model
```{r model_tuning}

# 6. Tune the grid ----
# check the number of available cores
# if available cores is greater than 5 default to 5 as diminishing  returns after this point (https://www.tmwr.org/resampling.html#parallel )

promotion_metrics <- metric_set(mn_log_loss, roc_auc, accuracy, sensitivity, specificity)
# cores <- ifelse(parallelly::availableCores()>5, 5, parallelly::availableCores())
# doParallel::registerDoParallel(cores = cores)


# set.seed(826)
# xgboost_resamples <- tune_grid(
#     xgboost_workflow,
#     resamples = promotion_folds,
#     grid = xgboost_grid,
#     metrics = promotion_metrics,
#     control = control_grid(save_pred = TRUE)
# )


# xgboost_resamples

```

# Assess Model Performance

```{r assess_model}

```


# Finalise and Predict
```{r finalise_workflow}

```






